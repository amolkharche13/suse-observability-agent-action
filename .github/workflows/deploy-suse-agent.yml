name: Install SUSE Observability Agent

on:
  workflow_dispatch:
    inputs:
      stackstateClusterName:
        description: "Cluster Name"
        required: true
      stackstate_API_Key:
        description: "Service token from StackState cluster (if you prefer, store this in secrets and reference secrets.stackstate_API_Key)."
        required: true
      stackstate_URL:
        description: "Stackstate cluster URL e.g. https://example.stackstate.io/receiver/stsAgent"
        required: true
      namespace:
        description: "Kubernetes namespace to install into"
        required: false
        default: "suse-observability"
      cluster-context:
        description: "Optional kubeconfig context to switch to before creating namespace (if using kubeconfig secret)."
        required: false
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig from secret (if provided)
        shell: bash
        env:
          KUBECONFIG_SECRET: ${{ secrets.KUBECONFIG }}
        run: |
          set -euo pipefail
          if [ -n "${KUBECONFIG_SECRET:-}" ]; then
            mkdir -p "$HOME/.kube"
            echo "$KUBECONFIG_SECRET" > "$HOME/.kube/config"
            chmod 600 "$HOME/.kube/config"
            echo "Wrote kubeconfig from secret to $HOME/.kube/config"
          else
            echo "No KUBECONFIG secret provided â€” assuming runner already has kube access or you are using a self-hosted runner with kube access."
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Switch context (optional)
        if: ${{ github.event.inputs['cluster-context'] != '' }}
        shell: bash
        run: |
          set -euo pipefail
          kubectl config use-context "${{ github.event.inputs['cluster-context'] }}" || true
          echo "Switched context to: ${{ github.event.inputs['cluster-context'] }}"

      - name: Ensure namespace exists
        shell: bash
        run: |
          set -euo pipefail
          NAMESPACE="${{ github.event.inputs.namespace }}"
          kubectl get ns "${NAMESPACE}" --ignore-not-found || kubectl create ns "${NAMESPACE}"
          echo "Ensured namespace ${NAMESPACE} exists"

      - name: Use local action to install SUSE Observability Agent
        uses: ./
        with:
          stackstate_API_Key: ${{ secrets.stackstate_API_Key }}
          stackstateClusterName: ${{ github.event.inputs.stackstateClusterName }}
          stackstate_URL: ${{ github.event.inputs.stackstate_URL }}
          Namespace: ${{ github.event.inputs.namespace }}
