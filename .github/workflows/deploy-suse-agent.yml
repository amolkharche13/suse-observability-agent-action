name: Install SUSE Observability Agent

on:
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig from secret (if provided)
        shell: bash
        env:
          KUBECONFIG_SECRET: ${{ secrets.KUBECONFIG }}
        run: |
          set -euo pipefail
          if [ -n "${KUBECONFIG_SECRET:-}" ]; then
            mkdir -p "$HOME/.kube"
            echo "$KUBECONFIG_SECRET" > "$HOME/.kube/config"
            chmod 600 "$HOME/.kube/config"
            echo "Wrote kubeconfig from secret to $HOME/.kube/config"
          else
            echo "No KUBECONFIG secret provided â€” assuming runner already has kube access or you are using a self-hosted runner with kube access."
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Ensure namespace exists
        shell: bash
        run: |
          set -euo pipefail
          kubectl get ns "${NAMESPACE}" --ignore-not-found || kubectl create ns "${NAMESPACE}"
          echo "Ensured namespace ${NAMESPACE} exists"

      - name: Use local action to install SUSE Observability Agent
        uses: ./
        with:
          stackstate_API_Key: ${{ secrets.stackstate_API_Key }}
          stackstateClusterName: "testing-amolk"
          stackstate_URL: "https://rancher-hosted.app.stackstate.io/receiver/stsAgent"
          Namespace: "suse-observability"
