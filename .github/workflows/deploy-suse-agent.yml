name: Install SUSE Observability Agent

on:
  workflow_dispatch:
  push:
    inputs:
      stackstateClusterName:
        description: "Cluster Name"
        required: true
      stackstate_API_Key:
        description: "Service token from Stackstate cluster"
        required: true
      stackstate_URL:
        description: "Stackstate cluster URL e.g. https://example.stackstate.io/receiver/stsAgent"
        required: true
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig from secret (if provided)
        shell: bash
        env:
          KUBECONFIG_SECRET: ${{ secrets.KUBECONFIG }}
        run: |
          set -euo pipefail
          if [ -n "${KUBECONFIG_SECRET:-}" ]; then
            mkdir -p "$HOME/.kube"
            echo "$KUBECONFIG_SECRET" > "$HOME/.kube/config"
            chmod 600 "$HOME/.kube/config"
            echo "Wrote kubeconfig from secret to $HOME/.kube/config"
          else
            echo "No KUBECONFIG secret provided â€” assuming runner already has kube access or you will use a self-hosted runner."
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Ensure namespace exists
        shell: bash
        run: |
          kubectl config use-context "${{ github.event.inputs.cluster-context }}" || true
          kubectl get ns my-namespace --ignore-not-found || kubectl create ns my-namespace
      

      - name: Use action to install SUSE Observability Agent
        uses: ./
        with:
          API_Key: ${{ secrets.stackstate_API_Key }}
          ClusterName: ${{ inputs.stackstateClusterName }}
          StackState_URL: ${{ inputs.stackstate_URL}}
          Namespace: "suse-observability"  
